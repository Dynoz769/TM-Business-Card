import { useState, useRef, useEffect } from 'react';

export default function PersistentImageCard() {
  const [rotation, setRotation] = useState(0);
  const [isDragging, setIsDragging] = useState(false);
  const [startX, setStartX] = useState(0);
  const cardRef = useRef(null);
  
  // State untuk menyimpan gambar yang diupload
  const [frontImage, setFrontImage] = useState(null);
  const [backImage, setBackImage] = useState(null);
  
  // Referensi untuk input file
  const frontImageInputRef = useRef(null);
  const backImageInputRef = useRef(null);

  // Load saved images on component mount
  useEffect(() => {
    const savedFrontImage = localStorage.getItem('frontCardImage');
    const savedBackImage = localStorage.getItem('backCardImage');
    
    if (savedFrontImage) {
      setFrontImage(savedFrontImage);
    }
    
    if (savedBackImage) {
      setBackImage(savedBackImage);
    }
  }, []);

  const handleMouseDown = (e) => {
    setIsDragging(true);
    setStartX(e.clientX);
  };

  const handleMouseMove = (e) => {
    if (!isDragging) return;
    
    const deltaX = e.clientX - startX;
    // Calculate new rotation, but limit it to front (0) or back (180) views
    let newRotation = rotation + deltaX * 0.5;
    
    // If we're closer to 0/360 than to 180, snap to 0/360, otherwise snap to 180
    if (newRotation % 360 < 90 || newRotation % 360 > 270) {
      newRotation = Math.round(newRotation / 360) * 360;
    } else {
      newRotation = Math.round((newRotation - 180) / 360) * 360 + 180;
    }
    
    setRotation(newRotation);
    setStartX(e.clientX);
  };

  const handleMouseUp = () => {
    setIsDragging(false);
    
    // Snap to either front (0) or back (180) when releasing
    const normalizedRotation = ((rotation % 360) + 360) % 360;
    if (normalizedRotation < 90 || normalizedRotation > 270) {
      setRotation(Math.round(rotation / 360) * 360);
    } else {
      setRotation(Math.round((rotation - 180) / 360) * 360 + 180);
    }
  };

  const flipCard = () => {
    const normalizedRotation = ((rotation % 360) + 360) % 360;
    if (normalizedRotation < 90 || normalizedRotation > 270) {
      setRotation(rotation + 180);
    } else {
      setRotation(rotation - 180);
    }
  };
  
  // Fungsi untuk menangani upload gambar depan dan menyimpannya
  const handleFrontImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const imageData = event.target.result;
        setFrontImage(imageData);
        localStorage.setItem('frontCardImage', imageData);
      };
      reader.readAsDataURL(file);
    }
  };
  
  // Fungsi untuk menangani upload gambar belakang dan menyimpannya
  const handleBackImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const imageData = event.target.result;
        setBackImage(imageData);
        localStorage.setItem('backCardImage', imageData);
      };
      reader.readAsDataURL(file);
    }
  };
  
  // Fungsi untuk menghapus gambar
  const clearFrontImage = () => {
    setFrontImage(null);
    localStorage.removeItem('frontCardImage');
  };
  
  const clearBackImage = () => {
    setBackImage(null);
    localStorage.removeItem('backCardImage');
  };

  // Add and remove event listeners
  useEffect(() => {
    if (isDragging) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    } else {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    }
    
    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, startX, rotation]);

  // Calculate which side is currently visible
  const normalizedRotation = ((rotation % 360) + 360) % 360;
  const isShowingFront = normalizedRotation < 90 || normalizedRotation > 270;

  return (
    <div className="w-full h-screen bg-gray-100 flex flex-col items-center justify-center p-4">
      <h2 className="text-xl font-bold mb-2">Kad Gambar Tersimpan</h2>
      <p className="text-sm text-gray-600 mb-4">Upload gambar yang akan disimpan secara permanen</p>
      
      {/* Upload area */}
      <div className="flex flex-wrap justify-center gap-4 mb-6">
        <div className="flex flex-col items-center">
          <button 
            onClick={() => frontImageInputRef.current.click()}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mb-1"
          >
            {frontImage ? "Tukar Gambar Depan" : "Upload Gambar Depan"}
          </button>
          <input 
            type="file" 
            ref={frontImageInputRef}
            onChange={handleFrontImageUpload}
            accept="image/*"
            className="hidden"
          />
          {frontImage && (
            <button 
              onClick={clearFrontImage}
              className="text-xs text-red-500 hover:text-red-700 mt-1"
            >
              Hapus Gambar
            </button>
          )}
        </div>
        
        <div className="flex flex-col items-center">
          <button 
            onClick={() => backImageInputRef.current.click()}
            className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 mb-1"
          >
            {backImage ? "Tukar Gambar Belakang" : "Upload Gambar Belakang"}
          </button>
          <input 
            type="file" 
            ref={backImageInputRef}
            onChange={handleBackImageUpload}
            accept="image/*"
            className="hidden"
          />
          {backImage && (
            <button 
              onClick={clearBackImage}
              className="text-xs text-red-500 hover:text-red-700 mt-1"
            >
              Hapus Gambar
            </button>
          )}
        </div>
      </div>
      
      <div className="perspective-500">
        <div 
          ref={cardRef}
          className="w-64 h-96 relative cursor-grab rounded-xl shadow-xl transition-transform duration-300"
          onMouseDown={handleMouseDown}
          style={{ 
            cursor: isDragging ? 'grabbing' : 'grab',
            transformStyle: 'preserve-3d',
            transform: `rotateY(${rotation}deg)`,
            transition: isDragging ? 'none' : 'transform 0.5s ease-out'
          }}
        >
          {/* Front Card */}
          <div 
            className="absolute w-full h-full rounded-xl overflow-hidden"
            style={{ backfaceVisibility: 'hidden', transform: 'translateZ(0.5px)' }}
          >
            {frontImage ? (
              <div className="w-full h-full relative">
                <img 
                  src={frontImage} 
                  alt="Gambar Depan" 
                  className="absolute w-full h-full object-cover"
                />
                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 text-white">
                  <h3 className="font-bold">DEPAN</h3>
                  <p className="text-xs">Geser untuk melihat belakang</p>
                </div>
              </div>
            ) : (
              <div className="w-full h-full bg-gradient-to-br from-blue-400 to-blue-600 flex flex-col items-center justify-center p-4">
                <div className="w-20 h-20 rounded-full bg-white mb-4 flex items-center justify-center">
                  <div className="text-blue-500 text-3xl font-bold">D</div>
                </div>
                <h3 className="text-white text-2xl font-bold mb-2">DEPAN</h3>
                <p className="text-white text-center mb-4">Upload gambar anda untuk sisi depan</p>
                <button 
                  onClick={() => frontImageInputRef.current.click()}
                  className="mt-2 px-4 py-2 bg-white text-blue-600 rounded hover:bg-blue-50"
                >
                  Upload Gambar
                </button>
              </div>
            )}
          </div>
          
          {/* Back Card */}
          <div 
            className="absolute w-full h-full rounded-xl overflow-hidden"
            style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg) translateZ(0.5px)' }}
          >
            {backImage ? (
              <div className="w-full h-full relative">
                <img 
                  src={backImage} 
                  alt="Gambar Belakang" 
                  className="absolute w-full h-full object-cover"
                />
                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 text-white">
                  <h3 className="font-bold">BELAKANG</h3>
                  <p className="text-xs">Geser untuk melihat depan</p>
                </div>
              </div>
            ) : (
              <div className="w-full h-full bg-gradient-to-br from-purple-400 to-purple-600 flex flex-col items-center justify-center p-4">
                <div className="w-20 h-20 rounded-full bg-white mb-4 flex items-center justify-center">
                  <div className="text-purple-500 text-3xl font-bold">B</div>
                </div>
                <h3 className="text-white text-2xl font-bold mb-2">BELAKANG</h3>
                <p className="text-white text-center mb-4">Upload gambar anda untuk sisi belakang</p>
                <button 
                  onClick={() => backImageInputRef.current.click()}
                  className="mt-2 px-4 py-2 bg-white text-purple-600 rounded hover:bg-purple-50"
                >
                  Upload Gambar
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
      
      <div className="mt-8 text-center">
        <p className="text-gray-700 font-medium mb-4">
          Anda sedang melihat sisi: <span className="font-bold">{isShowingFront ? "DEPAN" : "BELAKANG"}</span>
        </p>
        
        <button 
          className="px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow"
          onClick={flipCard}
        >
          Balik Kad
        </button>
      </div>
      
      <p className="mt-6 text-sm text-gray-500 text-center">
        Gambar yang diupload akan tersimpan di browser anda dan akan tetap ada meskipun halaman dimuat ulang
      </p>
    </div>
  );
}
